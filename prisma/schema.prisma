generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PlanType {
  FREE
  PREMIUM
}

enum PaymentStatus {
  PAID
  PENDING
  FAILED
}

enum SupportTier {
  STANDARD
  PRIORITY
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionMethod {
  CASH
  CARD
  PIX
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
}

model Member {
  id        Int       @id @unique @default(autoincrement())
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  name      String
  email     String    @unique
  phone     String?
  password  String

  plan          PlanType      @default(FREE)
  planStartDate DateTime      @default(now()) @map("plan_start_date")
  planEndDate   DateTime?     @map("plan_end_date")
  paymentStatus PaymentStatus @default(PAID) @map("payment_status")
  renewalDate   DateTime?     @map("renewal_date")

  timezone String @default("America/Sao_Paulo")
  language String @default("pt-BR")
  currency String @default("BRL")

  supportTier SupportTier @default(STANDARD) @map("support_tier")

  RefreshToken         RefreshToken[]
  Transaction          Transaction[]
  Goal                 Goal[]
  PaymentHistory       PaymentHistory[]
  Notification         Notification[]
  MemberMonthlySummary MemberMonthlySummary[]

  @@index([planStartDate, planEndDate])
  @@map("members")
}

model MemberMonthlySummary {
  id               Int      @id @default(autoincrement())
  memberId         Int      @map("member_id")
  month            DateTime
  totalIncome      Float    @default(0) @map("total_income")
  totalExpense     Float    @default(0) @map("total_expense")
  totalInvestments Float    @default(0) @map("total_investments")
  balance          Float    @default(0)

  member Member @relation(fields: [memberId], references: [id])

  @@unique([memberId, month])
  @@index([month])
  @@map("member_monthly_summary")
}

model PaymentHistory {
  id            Int           @id @unique @default(autoincrement())
  memberId      Int           @map("member_id")
  amount        Float
  paymentDate   DateTime      @map("payment_date")
  paymentMethod String        @map("payment_method")
  paymentStatus PaymentStatus @map("payment_status")
  externalId    String?       @map("external_id") // ID do gateway de pagamento

  member Member @relation(fields: [memberId], references: [id])

  @@index([paymentDate])
  @@map("payment_history")
}

model Transaction {
  id          Int               @id @unique @default(autoincrement())
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime?         @updatedAt @map("updated_at")
  memberId    Int               @map("member_id")
  type        TransactionType
  method      TransactionMethod
  title       String
  description String?
  category    String
  subCategory String
  amount      Float
  currency    String
  date        DateTime

  member Member @relation(fields: [memberId], references: [id])

  @@index([memberId, type, date])
  @@map("transactions")
}

model Goal {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  memberId      Int      @map("member_id")
  category      String
  targetAmount  Float    @map("target_amount")
  currentAmount Float    @default(0) @map("current_amount")

  member Member @relation(fields: [memberId], references: [id])

  @@index([memberId])
  @@map("goals")
}

model Notification {
  id        Int                  @id @unique @default(autoincrement())
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")
  memberId  Int                  @map("member_id")
  type      String
  message   String
  read      Boolean              @default(false)
  priority  NotificationPriority @default(LOW)

  member Member @relation(fields: [memberId], references: [id])

  @@index([memberId, read])
  @@map("notifications")
}

model RefreshToken {
  id        Int      @id @unique @default(autoincrement())
  token     String
  expiresIn DateTime @map("expires_in")
  createdAt DateTime @default(now()) @map("created_at")
  memberId  Int      @map("member_id")

  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("refresh_tokens")
}
